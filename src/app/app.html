<div class="min-h-screen bg-slate-50 font-sans pb-20">

  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200 px-6 py-4 mb-8 shadow-sm">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-700 to-indigo-600 tracking-tight">
          Tablero Comercial
        </h1>
        <p class="text-xs font-semibold text-slate-400 uppercase tracking-widest mt-1">Gestión de Indicadores 2026</p>
      </div>
      
    </div>
  </header>

  <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
    <nz-spin [nzSpinning]="isDashboardLoading">

      <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/60 border border-slate-100 p-1 mb-10">
        <div class="p-6">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
              <h2 class="text-lg font-bold text-slate-800 flex items-center gap-3">
                <div class="p-2 bg-indigo-50 text-indigo-600 rounded-lg shadow-sm">
                  <i nz-icon nzType="line-chart" nzTheme="outline"></i>
                </div>
                Comparativa de Mercado
              </h2>
              <p class="text-sm text-slate-400 mt-1 ml-11">Analiza tendencias entre múltiples marcas</p>
            </div>
            
            <div class="w-full md:w-1/2 lg:w-1/3">
              <nz-select 
                nzMode="multiple" 
                nzPlaceHolder="Selecciona marcas para comparar..." 
                class="w-full rounded-lg shadow-sm"
                [(ngModel)]="marcasComparacion"
                (ngModelChange)="actualizarGrafico()">
                <nz-option *ngFor="let m of todasLasMarcas" [nzValue]="m" [nzLabel]="m"></nz-option>
              </nz-select>
            </div>
          </div>
          
          <div class="h-80 w-full bg-gradient-to-b from-slate-50 to-white rounded-xl border border-slate-100 p-4 relative">
             <div id="container-grafico" class="h-full w-full"></div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/60 border border-slate-100 overflow-hidden">
        
        <div class="bg-slate-50/80 border-b border-slate-200 p-6 flex flex-wrap justify-between items-end gap-6">
          <div>
            <h3 class="text-lg font-bold text-slate-800 flex items-center gap-3">
              <div class="p-2 bg-blue-50 text-blue-600 rounded-lg shadow-sm">
                <i nz-icon nzType="edit" nzTheme="outline"></i>
              </div>
              Editor de Metas
            </h3>
            <p class="text-sm text-slate-400 mt-1 ml-11">Ajusta las proyecciones y ventas reales</p>
          </div>

          <div class="flex flex-wrap items-center gap-3 bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
            
            <div class="px-2 border-r border-slate-100">
              <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wider">Categoría</label>
              <nz-select style="width: 140px;" class="border-transparent" [(ngModel)]="catSeleccionada" (ngModelChange)="actualizarListaMarcasEdicion()">
                <nz-option *ngFor="let c of categorias" [nzValue]="c" [nzLabel]="c"></nz-option>
              </nz-select>
            </div>

            <div class="px-2">
              <label class="block text-[10px] font-bold text-blue-600 mb-1 uppercase tracking-wider">Marca Activa</label>
              <nz-select style="width: 180px;" 
                [(ngModel)]="marcaEdicion" 
                (ngModelChange)="cargarDatosTabla()"
                nzPlaceHolder="Selecciona...">
                <nz-option *ngFor="let m of marcasForm" [nzValue]="m" [nzLabel]="m"></nz-option>
              </nz-select>
            </div>

            <button nz-button nzType="primary" 
              [disabled]="!marcaEdicion" 
              [nzLoading]="isSaving"
              (click)="guardarTodo()"
              class="ml-2 h-10 bg-gradient-to-r from-blue-600 to-indigo-600 border-none font-bold px-6 rounded-lg shadow-lg shadow-blue-500/30 hover:shadow-blue-600/40 hover:scale-105 transition-all duration-200 flex items-center">
              <i nz-icon nzType="save" class="mr-2"></i> GUARDAR
            </button>
          </div>
        </div>

        <div *ngIf="!marcaEdicion" class="p-16 text-center bg-slate-50/30">
          <nz-empty 
            nzNotFoundImage="https://gw.alipayobjects.com/zos/antfincdn/ZHrcdLPrvN/empty.svg"
            [nzNotFoundContent]="contentTpl">
            <ng-template #contentTpl>
              <span class="text-slate-400 font-medium">Selecciona una marca arriba para desbloquear el editor</span>
            </ng-template>
          </nz-empty>
        </div>

        <div *ngIf="marcaEdicion" class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="bg-white border-b border-slate-200">
                <th class="p-4 text-left w-40 sticky left-0 bg-white z-20 font-bold text-xs text-slate-400 uppercase tracking-wider shadow-[4px_0_24px_-2px_rgba(0,0,0,0.05)]">
                  Indicador
                </th>
                <th *ngFor="let item of indicadoresMes" class="p-4 text-center font-bold text-slate-500 text-xs uppercase tracking-wider">
                  {{ item.mes }}
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-50">
              
              <tr class="group hover:bg-blue-50/30 transition-colors duration-150">
                <td class="p-4 font-bold text-blue-700 sticky left-0 bg-white group-hover:bg-blue-50/30 z-10 shadow-[4px_0_24px_-2px_rgba(0,0,0,0.05)] border-r border-transparent">
                  <div class="flex items-center gap-2">
                    <div class="w-1 h-8 bg-blue-500 rounded-full"></div>
                    REAL (S/.)
                  </div>
                </td>
                <td *ngFor="let item of indicadoresMes" class="p-2 text-center">
                  <input type="number" [(ngModel)]="item.real" 
                    class="w-full text-center py-2 px-1 bg-transparent border border-transparent rounded-lg font-bold text-slate-700 focus:bg-white focus:border-blue-400 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all duration-200 hover:border-slate-200 placeholder-slate-300">
                </td>
              </tr>

              <tr class="group hover:bg-green-50/30 transition-colors duration-150">
                <td class="p-4 font-bold text-green-700 sticky left-0 bg-white group-hover:bg-green-50/30 z-10 shadow-[4px_0_24px_-2px_rgba(0,0,0,0.05)] border-r border-transparent">
                  <div class="flex items-center gap-2">
                    <div class="w-1 h-8 bg-green-500 rounded-full"></div>
                    META (S/.)
                  </div>
                </td>
                <td *ngFor="let item of indicadoresMes" class="p-2 text-center">
                  <input type="number" [(ngModel)]="item.meta" 
                    class="w-full text-center py-2 px-1 bg-transparent border border-transparent rounded-lg font-medium text-slate-600 focus:bg-white focus:border-green-400 focus:ring-4 focus:ring-green-500/10 outline-none transition-all duration-200 hover:border-slate-200 placeholder-slate-300">
                </td>
              </tr>

              <tr class="bg-white">
                <td class="p-4 font-semibold text-slate-500 sticky left-0 bg-white z-10 shadow-[4px_0_24px_-2px_rgba(0,0,0,0.05)]">
                  Variación
                </td>
                <td *ngFor="let item of indicadoresMes" class="p-3 text-center">
                  <ng-container *ngIf="item.meta > 0; else sinMeta">
                    <div class="inline-flex items-center justify-center gap-1 px-2 py-1 rounded-md text-xs font-bold transition-colors duration-300"
                      [ngClass]="((item.real - item.meta) / item.meta) >= 0 
                        ? 'bg-green-50 text-green-600 border border-green-100' 
                        : 'bg-red-50 text-red-600 border border-red-100'">
                      
                      <span *ngIf="((item.real - item.meta) / item.meta) > 0">▲</span>
                      <span *ngIf="((item.real - item.meta) / item.meta) < 0">▼</span>
                      <span>{{ ((item.real - item.meta) / item.meta) * 100 | number:'1.0-0' }}%</span>
                    </div>
                  </ng-container>
                  <ng-template #sinMeta>
                    <span class="text-slate-200 font-light text-xl">·</span>
                  </ng-template>
                </td>
              </tr>

              <tr class="bg-slate-50/50">
                <td class="p-4 font-semibold text-slate-500 sticky left-0 bg-slate-50 z-10 shadow-[4px_0_24px_-2px_rgba(0,0,0,0.05)] border-t border-slate-100">
                  Score
                </td>
                <td *ngFor="let item of indicadoresMes" class="p-3 text-center border-t border-slate-100">
                   <ng-container *ngIf="item.meta > 0; else sinMetaScore">
                      
                      <span class="inline-flex items-center justify-center w-9 h-9 rounded-full text-white text-[11px] font-bold shadow-md hover:scale-110 transition-transform cursor-default"
                        [ngClass]="{
                          'bg-green-500': item.score >= 100,
                          'bg-emerald-400': item.score >= 80 && item.score < 100,
                          'bg-yellow-400': item.score >= 50 && item.score < 80,
                          'bg-red-400': item.score < 50
                        }">
                        {{ item.score }}
                      </span>

                   </ng-container>
                   <ng-template #sinMetaScore>
                      <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-200 text-slate-400 text-[10px] font-bold">0</span>
                   </ng-template>
                </td>
              </tr>

            </tbody>
          </table>
        </div>
      </div>

    </nz-spin>
  </div>
</div>